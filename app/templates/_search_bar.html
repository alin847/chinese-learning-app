<div class="search-bar">
<div class="search-input-wrapper">
    <!-- Search icon -->
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-4.35-4.35m1.65-5.65a7 7 0 11-14 0 7 7 0 0114 0z" />
    </svg>

    <!-- Search input -->
    <input type="text" id="search-input" placeholder="What do you want to learn?" />

    <!-- Search toggle -->
    <div class="lang-toggle">
        <input type="checkbox" id="lang-switch" />
        <label for="lang-switch" id="lang-label"></label>
    </div>

    <!-- Search dropdown -->
    <div class="search-dropdown" id="search-dropdown"></div>
</div>
</div>

<script>
const input = document.getElementById('search-input');
const dropdown = document.getElementById('search-dropdown');
const langSwitch = document.getElementById('lang-switch');

let debounceTimer = null;

// Dropdown feature
input.addEventListener('input', () => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
        const query = cleanQuery(input.value);

        if (!query) {
            dropdown.style.display = 'none';
            return;
        }

        const chinese = !langSwitch.checked;
        const queryType = getQueryType(query, chinese);
        const url = `/search?${queryType}=${encodeURIComponent(query)}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
            if (data.length === 0) {
                dropdown.style.display = 'none';
                return;
            }
            // Populate 5 entries
            data = data.slice(0, 5);
            populateDropdown(data);
            })
            .catch(error => {
            console.error('Error fetching search results:', error);
            dropdown.style.display = 'none';
            });
    }, 100); // Adjust debounce time as needed
});

// hide dropdown if click outside
document.addEventListener('click', (e) => {
    if (!dropdown.contains(e.target) && e.target !== input) {
        dropdown.style.display = 'none';
    }
});

// Redirect on Enter key
document.getElementById('search-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        const query = cleanQuery(e.target.value);
        const type = getQueryType(query, !langSwitch.checked);
        if (query) {
        window.location.href = `/search/${type}/${encodeURIComponent(query)}`;
        }
    }
});

// Save toggle state
window.addEventListener('DOMContentLoaded', () => {
    const savedState = localStorage.getItem('langToggleState');
    if (savedState !== null) {
        langSwitch.checked = savedState === 'true';
    }
});

langSwitch.addEventListener('change', () => {
    localStorage.setItem('langToggleState', langSwitch.checked);
});

// Helper
function cleanQuery(str) {
    return str.trim().replace(/[0-9]/g, '');
}

function getQueryType(query, chinese) {
    if (!chinese) return 'definitions';

    const hasChinese = /[\u4e00-\u9fff]/.test(query);
    if (hasChinese) return 'simplified';

    return 'pinyin'
}

function populateDropdown(data) {
    dropdown.innerHTML = '';
    data.forEach(item => {
        const div = document.createElement('div');
        div.classList.add( 'search-dropdown-item');

        // First line: character and pinyin
        const line1 = document.createElement('div');
        line1.textContent = `${item.simplified} (${item.pinyin})`;
        line1.classList.add('search-dropdown-line1');

        // Second line: definition
        const line2 = document.createElement('div');
        line2.textContent = item.definitions.map((def, i) => `${i + 1}. ${def}`).join('  ');
        line2.classList.add('search-dropdown-line2');

        // Click behavior
        div.addEventListener('click', () => {
        window.location.href = `/search/id/${item.id}`;
        });
        div.appendChild(line1);
        div.appendChild(line2);
        dropdown.appendChild(div);
        dropdown.style.display = 'block';
    });
}
</script>